<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>以撒道具/饰品图像识别 | YiMing's blog</title>
    <meta name="description" content="自定义训练数据的以撒道具图像识别, 《以撒的结合》训练数据道具装备识别">
    <link rel="preload stylesheet" href="/assets/style.cb8d09bc.css" as="style">
    <script type="module" src="/assets/app.bb2119bd.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
  <link rel="modulepreload" href="/assets/chunks/framework.41330901.js">
  <link rel="modulepreload" href="/assets/chunks/theme.500c9978.js">
  <link rel="modulepreload" href="/assets/blog_posts_2024_Isaac_image_recognition.md.9fd3c83f.lean.js">
  <link rel="icon" href="yiminglogo2.png">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-2bf54a99><!--[--><!--]--><!--[--><span tabindex="-1" data-v-f5a352f2></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-f5a352f2> Skip to content </a><!--]--><!----><header class="VPNav" data-v-2bf54a99 data-v-283c37a7><div class="VPNavBar" data-v-283c37a7 data-v-2264840b><div class="container" data-v-2264840b><div class="title" data-v-2264840b><div class="VPNavBarTitle" data-v-2264840b data-v-d298091b><a class="title" href="/" data-v-d298091b><!--[--><!--]--><!--[--><img class="VPImage logo" src="/yiminglogo2.png" alt data-v-6dd5884f><!--]--><!--[-->YiMing&#39;s Blog<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-2264840b><div class="curtain" data-v-2264840b></div><div class="content-body" data-v-2264840b><!--[--><!--]--><div class="VPNavBarSearch search" style="--vp-meta-key:&#39;Meta&#39;;" data-v-2264840b><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg class="DocSearch-Search-Icon" width="20" height="20" viewBox="0 0 20 20" aria-label="search icon"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-2264840b data-v-f54c34e6><span id="main-nav-aria-label" class="visually-hidden" data-v-f54c34e6>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/" tabindex="0" data-v-f54c34e6 data-v-bdc88584 data-v-d502cd7b><!--[-->Home<!--]--><!----></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-f54c34e6 data-v-529736ff><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-529736ff><span class="text" data-v-529736ff><!----> Blog <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-529736ff><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-529736ff><div class="VPMenu" data-v-529736ff data-v-280e28cb><div class="items" data-v-280e28cb><!--[--><!--[--><div class="VPMenuLink" data-v-280e28cb data-v-2a9f32f4><a class="VPLink link" href="/blog/" data-v-2a9f32f4 data-v-d502cd7b><!--[-->Blog Home<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-280e28cb data-v-2a9f32f4><a class="VPLink link" href="/blog/tags.html" data-v-2a9f32f4 data-v-d502cd7b><!--[-->Tags<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-280e28cb data-v-2a9f32f4><a class="VPLink link" href="/blog/archives.html" data-v-2a9f32f4 data-v-d502cd7b><!--[-->Archives<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blog/authors/yi-ming.html" tabindex="0" data-v-f54c34e6 data-v-bdc88584 data-v-d502cd7b><!--[-->About<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-2264840b data-v-0088fcc3><label title="toggle dark mode" data-v-0088fcc3 data-v-6efeb7e0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-checked="false" data-v-6efeb7e0 data-v-5c77962f><span class="check" data-v-5c77962f><span class="icon" data-v-5c77962f><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-6efeb7e0><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-6efeb7e0><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></label></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-2264840b data-v-f8334a3a data-v-c74e4df9><!--[--><a class="VPSocialLink" href="https://github.com/realzhengyiming" aria-label="github" target="_blank" rel="noopener" data-v-c74e4df9 data-v-d6790091><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-2264840b data-v-206ebc7c data-v-529736ff><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-529736ff><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-529736ff><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-529736ff><div class="VPMenu" data-v-529736ff data-v-280e28cb><!----><!--[--><!--[--><!----><div class="group" data-v-206ebc7c><div class="item appearance" data-v-206ebc7c><p class="label" data-v-206ebc7c>Appearance</p><div class="appearance-action" data-v-206ebc7c><label title="toggle dark mode" data-v-206ebc7c data-v-6efeb7e0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-checked="false" data-v-6efeb7e0 data-v-5c77962f><span class="check" data-v-5c77962f><span class="icon" data-v-5c77962f><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-6efeb7e0><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-6efeb7e0><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></label></div></div></div><div class="group" data-v-206ebc7c><div class="item social-links" data-v-206ebc7c><div class="VPSocialLinks social-links-list" data-v-206ebc7c data-v-c74e4df9><!--[--><a class="VPSocialLink" href="https://github.com/realzhengyiming" aria-label="github" target="_blank" rel="noopener" data-v-c74e4df9 data-v-d6790091><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-2264840b data-v-47edab87><span class="container" data-v-47edab87><span class="top" data-v-47edab87></span><span class="middle" data-v-47edab87></span><span class="bottom" data-v-47edab87></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav" data-v-2bf54a99 data-v-b59ad933><!----><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-b59ad933 data-v-c20a59a7><button data-v-c20a59a7>Return to top</button><!----></div></div><!----><div class="VPContent" id="VPContent" data-v-2bf54a99 data-v-e1441724><div class="VPDoc has-aside" data-v-e1441724 data-v-e031c361><!--[--><!--]--><div class="container" data-v-e031c361><div class="left-aside aside" data-v-e031c361><div class="aside-curtain" data-v-e031c361></div><div class="aside-container" data-v-e031c361><div class="aside-content" data-v-e031c361><div class="VPDocAside" data-v-e031c361 data-v-6db944aa><!--[--><!--[--><!--[--><!--[--><!--[--><span class="bg-primary-100 inline-flex items-center rounded text-sm font-medium"><div data-v-262d93ff><div class="i-[heroicons-outline/academic-cap] mr-2" data-v-262d93ff></div><span data-v-262d93ff>Tutorial</span></div></span><span class="bg-primary-100 inline-flex rounded text-sm font-medium"><div class="flex flex-wrap gap-2 py-5"><!--[--><a class="rounded-sm bg-gray-100 px-2 py-1 text-xs font-semibold text-gray-600" href="/blog/tags?init=深度学习"><!----> 深度学习</a><a class="rounded-sm bg-gray-100 px-2 py-1 text-xs font-semibold text-gray-600" href="/blog/tags?init=图像识别"><!----> 图像识别</a><a class="rounded-sm bg-gray-100 px-2 py-1 text-xs font-semibold text-gray-600" href="/blog/tags?init=以撒的结合"><!----> 以撒的结合</a><!--]--></div></span><dl class="pb-10 pt-6 xl:border-b xl:border-gray-200 xl:pt-11 dark:xl:border-slate-200/5" data-v-f51709bc><dt class="sr-only" data-v-f51709bc>Authors</dt><dd data-v-f51709bc><ul class="flex justify-center space-x-8 sm:space-x-12 xl:block xl:space-x-0 xl:space-y-8" data-v-f51709bc><li class="flex items-center space-x-2" data-v-f51709bc><img src="https://avatars.githubusercontent.com/u/26131338?v=4" alt="author image" class="h-10 w-10 rounded-full" data-v-f51709bc><dl class="whitespace-nowrap text-sm font-medium leading-5" data-v-f51709bc><dt class="sr-only" data-v-f51709bc>Name</dt><dd class="text-gray-900 dark:text-white" data-v-f51709bc><a href="/blog/authors/yi-ming.html" class="text-lg text-gray-900 hover:text-[color:var(--vp-c-brand-light)] dark:text-white dark:hover:text-[color:var(--vp-c-brand-dark)]" data-v-f51709bc>Yi Ming</a></dd><!----><!----></dl></li></ul></dd></dl><!--]--><!--]--><!--]--><!--]--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-6db944aa data-v-12ef9dee><div class="content" data-v-12ef9dee><div class="outline-marker" data-v-12ef9dee></div><div class="outline-title" data-v-12ef9dee>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-12ef9dee><span class="visually-hidden" id="doc-outline-aria-label" data-v-12ef9dee> Table of Contents for current page </span><ul class="root" data-v-12ef9dee data-v-df1a6cf2><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-6db944aa></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--[--><!--[--><!--[--><footer class="mb-24 divide-y divide-gray-200 text-sm font-medium leading-5 dark:divide-slate-200/5" data-v-2f3a5683><div class="py-3" data-v-2f3a5683><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-white" data-v-2f3a5683> Next Article </h2><div class="link" data-v-2f3a5683><a href="/blog/posts/2024/Ollama_Local_Inference&amp;Summary_Generation_Capability.html" data-v-2f3a5683>Ollama本地推理&amp;文本标题生成</a></div></div><div class="py-3" data-v-2f3a5683><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-white" data-v-2f3a5683> Previous Article </h2><div class="link" data-v-2f3a5683><a href="/blog/posts/2024/llm_agent.html" data-v-2f3a5683>LLM Agent 解读</a></div></div><div class="pt-3" data-v-2f3a5683><a class="link" href="/blog/" data-v-2f3a5683>← Back to the blog</a></div></footer><!----><!--]--><!--]--><!--]--><!--]--></div></div></div></div><div class="content" data-v-e031c361><div class="content-container" data-v-e031c361><!--[--><!--[--><!--[--><!--[--><header class="space-y-1 pt-6 text-center xl:pb-10"><dl><dt class="sr-only">Published on</dt><dd class="text-base font-medium leading-6 text-gray-500 dark:text-gray-300"><time datetime="2024-01-29T12:00:00.000Z">January 29, 2024</time></dd></dl><h1 class="md:leading-14 text-3xl font-extrabold leading-9 tracking-tight text-[color:var(--vp-c-brand-dark)] dark:text-[color:var(--vp-c-brand-light)] sm:text-4xl sm:leading-10 md:text-5xl">以撒道具/饰品图像识别</h1></header><!--[--><div class="xs:show xl:hidden flex justify-center space-x-8 sm:space-x-12 xl:block xl:space-x-0 xl:space-y-8"><span class="bg-primary-100 inline-flex items-center rounded text-sm font-medium"><div data-v-262d93ff><div class="i-[heroicons-outline/academic-cap] mr-2" data-v-262d93ff></div><span data-v-262d93ff>Tutorial</span></div></span></div><dl class="pb-10 pt-6 xl:border-b xl:border-gray-200 xl:pt-11 dark:xl:border-slate-200/5 xs:show xl:hidden" data-v-f51709bc><dt class="sr-only" data-v-f51709bc>Authors</dt><dd data-v-f51709bc><ul class="flex justify-center space-x-8 sm:space-x-12 xl:block xl:space-x-0 xl:space-y-8" data-v-f51709bc><li class="flex items-center space-x-2" data-v-f51709bc><img src="https://avatars.githubusercontent.com/u/26131338?v=4" alt="author image" class="h-10 w-10 rounded-full" data-v-f51709bc><dl class="whitespace-nowrap text-sm font-medium leading-5" data-v-f51709bc><dt class="sr-only" data-v-f51709bc>Name</dt><dd class="text-gray-900 dark:text-white" data-v-f51709bc><a href="/blog/authors/yi-ming.html" class="text-lg text-gray-900 hover:text-[color:var(--vp-c-brand-light)] dark:text-white dark:hover:text-[color:var(--vp-c-brand-dark)]" data-v-f51709bc>Yi Ming</a></dd><!----><!----></dl></li></ul></dd></dl><!--]--><!--]--><!----><!--]--><!--]--><!--]--><!----><main class="main" data-v-e031c361><div style="position:relative;" class="vp-doc _blog_posts_2024_Isaac_image_recognition" data-v-e031c361><div><h1 id="引言" tabindex="-1">引言 <a class="header-anchor" href="#引言" aria-label="Permalink to &quot;引言&quot;">​</a></h1><p><img src="/assets/自定义训练数据图像识别-2024-01-29.a602417e.png" alt=""> 最近在玩《以撒的结合:忏悔》, ns版本. 游戏确实上头好玩, 内容很多. 但是游玩下来遇到一个纠结头疼的问题就是, 道具/ 装备 有时候捡起来后的效果, 还不如不捡. 装备/道具只会在捡起来的时候才能看到道具和状态是什么, 甚至, 有时候捡起来后描述也看不出这个道具到底能用来干嘛, 魂系叙事那一套......虽然也找到不错的<a href="https://isaac.huijiwiki.com/wiki/%E9%A6%96%E9%A1%B5" target="_blank" rel="noreferrer">以撒的结合中文维基</a>, 但是, 站点只能文字搜索, 再加上其道具和饰品加起来总数量有900多个, 相当于ImageNet的种类了. 于是就想到, 干脆做一个<strong>以撒道具图像识别功能</strong> 好了, 优化体验: ) .</p><hr><div style="z-index:1000;position:absolute;left:0px;top:0px;transform:translate(100.484px, 200.938px);transition:transform 2s;" data-v-896f29e3><div id="baby_plum" class="baby_plum_anim baby_plum_anm_Idle" style="position:absolute;left:0px;top:0px;" data-v-896f29e3></div></div><h1 id="自定义训练数据图像识别" tabindex="-1">自定义训练数据图像识别 <a class="header-anchor" href="#自定义训练数据图像识别" aria-label="Permalink to &quot;自定义训练数据图像识别&quot;">​</a></h1><p>得益于各种深度学习框架的发展, 现在训练一个模型变得非常简单, 于是我就决定直接用<code>pytorch</code>来完成这个图片识别的任务了. 考虑到以撒的道具装备这类东西图像数据是非常<strong>垂直领域</strong>了, 所以我需要准备对应的训练数据进行模型的训练.</p><h1 id="数据准备" tabindex="-1">数据准备 <a class="header-anchor" href="#数据准备" aria-label="Permalink to &quot;数据准备&quot;">​</a></h1><h2 id="数据获取-数据合成" tabindex="-1">数据获取&amp;数据合成 <a class="header-anchor" href="#数据获取-数据合成" aria-label="Permalink to &quot;数据获取&amp;数据合成&quot;">​</a></h2><p>从<a href="https://isaac.huijiwiki.com/wiki/%E9%A6%96%E9%A1%B5" target="_blank" rel="noreferrer">以撒的结合中文维基</a> 编写爬虫把道具/装备的图片数据, 描述都抓取下来.<br> 爬虫比较简单, 主要就是图片爬取的时候, 需要从css中把sprite图子图的x, y提取出来, 然后自行使用sprite划分独立的道具图. 下图为css和html标签中抽取出来的信息</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">collectibles_001</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">x</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">32</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">y</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">en</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">The Sad Onion</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">zh</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">悲伤洋葱</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">level</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">1</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">type</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">道具</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">level2</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">3</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">?</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">desc</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">射速上升。</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">new_id</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">image</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./cus_data/0.png</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">},</span><span style="color:#A6ACCD;"> ...</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 提取出每个道具的图片和其他属性</span></span></code></pre></div><p>然后把图片分割后某个目录, 此处我是把裁切好的图片存放在 <code>./cus_data</code>下. 并且把图片. 整理后得到训练的类别标签备用.</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&gt;&gt;&gt;</span><span style="color:#A6ACCD;">classes</span></span>
<span class="line"><span style="color:#89DDFF;">{</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">悲伤洋葱:射速上升。</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">内眼:角色每次发射3颗泪弹。</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">弯勺魔术:角色的泪弹获得追踪效果。</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">柯吉猫的头:泪弹变大，击退效果上升，伤害上升。</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">我的镜像:角色的泪弹会飞回角色身边。</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">小号:射程下降，射速上升。</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> ...</span></span></code></pre></div><p>此处我把图片裁剪下来的32x32大小的图片保存为合成训练数据的元数据, 因为是像素风格, 所以哪怕所缩小了,只要不使用平滑, 那还是非常清晰的. <img src="/assets/自定义训练数据图像识别-像素风格-2024-01-29.4b132729.png" alt=""><br> (数据获得和处理完整代码在末尾的引用中会给出链接.)</p><h2 id="数据增强" tabindex="-1">数据增强 <a class="header-anchor" href="#数据增强" aria-label="Permalink to &quot;数据增强&quot;">​</a></h2><p>实际的预测情况都伴随着各种各样的背景干扰, 所以这边需要在合成训练数据的时候, 也需要让这些元图标拥有各种各样的背景. <img src="/assets/自定义训练数据图像识别-数据合成多背景-2024-01-29.0f002570.png" alt=""> 另一方面, 考虑到一个场景就是使用摄像头的拍照的时候, 可能会有的一些图像的畸变和变形等. transform中也需要配置数据增强的操作, 包括但不限于, 抖动, 明暗度变化等.</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> torchvision</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">transforms </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> ToTensor</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">transform </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Compose</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">    </span><span style="color:#89DDFF;">[</span></span>
<span class="line"><span style="color:#82AAFF;">        transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Lambda</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">lambda</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">x</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">float</span><span style="color:#89DDFF;">()),</span></span>
<span class="line"><span style="color:#82AAFF;">    </span><span style="color:#89DDFF;">])</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 先直接配置一个用来计算 数据均值和标准差,以方便正则化</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 配置初始的dataloader用于遍历和计算均值和标准差</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> torchvision</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">io </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> read_image</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">IssacCustomDatasets</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Dataset</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__init__</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;font-style:italic;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">img_sort_files</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">                 </span><span style="color:#A6ACCD;font-style:italic;">img_dir</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">transform</span><span style="color:#89DDFF;">=None,</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#A6ACCD;font-style:italic;">target_transform</span><span style="color:#89DDFF;">=None):</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">img_labels</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> img_sort_files</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># 自定义标签关系, 此处需要排好序的</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">img_dir</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> img_dir</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">transform</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> transform</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">target_transform</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> target_transform</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__len__</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;font-style:italic;">self</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">img_labels</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__getitem__</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;font-style:italic;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">idx</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 作用是获得label 和 item 即可</span></span>
<span class="line"><span style="color:#A6ACCD;">        filename </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">img_labels</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">idx</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">        img_path </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> os</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">img_dir</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> filename</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        image </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">read_image</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">img_path</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">mode</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">torchvision</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">io</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">ImageReadMode</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">RGB</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        label </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">filename</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">split</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">])</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">transform</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">            image </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">transform</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">image</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">target_transform</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">            label </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">target_transform</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">label</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> image</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> label</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">from_dir </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">new_cus_data</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">need_move_images </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> os</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">listdir</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">new_cus_data/</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">need_move_images </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> need_move_images </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">i</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">split</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">])</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">need_move_images</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sort</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">key</span><span style="color:#89DDFF;">=</span><span style="color:#C792EA;">lambda</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">x</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;</span><span style="color:#F78C6C;">{</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">split</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">])</span><span style="color:#C792EA;">:03d</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&quot;</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">+</span><span style="color:#82AAFF;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;</span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">split</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">need_move_images</span><span style="color:#89DDFF;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">train_dataset </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IssacCustomDatasets</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">img_sort_files</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">need_move_images</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">img_dir</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">new_cus_data/</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">                                    </span><span style="color:#A6ACCD;font-style:italic;">transform</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">transform</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">## dataloader</span></span>
<span class="line"><span style="color:#A6ACCD;">train_dataloader </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">DataLoader</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataset</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span></span>
<span class="line"><span style="color:#82AAFF;">                              </span><span style="color:#A6ACCD;font-style:italic;">batch_size</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">batch_size</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span></span>
<span class="line"><span style="color:#82AAFF;">                              </span><span style="color:#A6ACCD;font-style:italic;">shuffle</span><span style="color:#89DDFF;">=True)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 获取图片数据的 归一化数值</span></span>
<span class="line"><span style="color:#A6ACCD;">global_mean </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[]</span></span>
<span class="line"><span style="color:#A6ACCD;">global_std </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[]</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> images</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> labels </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> train_dataloader</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    numpy_image </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> images</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">numpy</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    batch_mean </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> np</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">mean</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">numpy_image</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">axis</span><span style="color:#89DDFF;">=(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">    batch_std </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> np</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">std</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">numpy_image</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">axis</span><span style="color:#89DDFF;">=(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">    global_mean</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">append</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">batch_mean</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    global_std</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">append</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">batch_std</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">global_mean </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> np</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">mean</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">global_mean</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">axis</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">tolist</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">global_std </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> np</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">mean</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">global_std</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">axis</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">tolist</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">global_mean</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">global_std</span><span style="color:#89DDFF;">)</span></span></code></pre></div><p>再次根据得到的均值和标准差更新训练用的dataloader</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> torchvision</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">transforms </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> ToTensor</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">transform </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Compose</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">    </span><span style="color:#89DDFF;">[</span></span>
<span class="line"><span style="color:#82AAFF;">        transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">RandomAffine</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">degrees</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">translate</span><span style="color:#89DDFF;">=None,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">scale</span><span style="color:#89DDFF;">=(</span><span style="color:#F78C6C;">0.9</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1.1</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">shear</span><span style="color:#89DDFF;">=None),</span><span style="color:#82AAFF;">  </span></span>
<span class="line"><span style="color:#82AAFF;">        </span><span style="color:#676E95;font-style:italic;"># 随机放大或者缩小一点点</span></span>
<span class="line"><span style="color:#82AAFF;">        </span><span style="color:#676E95;font-style:italic;"># 增加噪声, 防止过拟合</span></span>
<span class="line"><span style="color:#82AAFF;">        transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ColorJitter</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">            </span><span style="color:#A6ACCD;font-style:italic;">brightness</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.1</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">            </span><span style="color:#A6ACCD;font-style:italic;">contrast</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.1</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">            </span><span style="color:#A6ACCD;font-style:italic;">saturation</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.1</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">            </span><span style="color:#A6ACCD;font-style:italic;">hue</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.1</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;">  </span><span style="color:#676E95;font-style:italic;"># 抖动图像的亮度、对比度、饱和度和色相</span></span>
<span class="line"><span style="color:#82AAFF;">        transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Lambda</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">lambda</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">x</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">float</span><span style="color:#89DDFF;">()),</span></span>
<span class="line"><span style="color:#82AAFF;">        transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Normalize</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">            global_mean</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">            global_std</span></span>
<span class="line"><span style="color:#82AAFF;">        </span><span style="color:#89DDFF;">)</span><span style="color:#82AAFF;">  </span><span style="color:#676E95;font-style:italic;"># 对图片数据做正则化</span></span>
<span class="line"><span style="color:#82AAFF;">    </span><span style="color:#89DDFF;">])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">train_dataset </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IssacCustomDatasets</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">need_move_images</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">img_dir</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">new_cus_data/</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">transform</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">transform</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">## dataloader</span></span>
<span class="line"><span style="color:#A6ACCD;">train_dataloader </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">DataLoader</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataset</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span></span>
<span class="line"><span style="color:#82AAFF;">                              </span><span style="color:#A6ACCD;font-style:italic;">batch_size</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">batch_size</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span></span>
<span class="line"><span style="color:#82AAFF;">                              </span><span style="color:#A6ACCD;font-style:italic;">shuffle</span><span style="color:#89DDFF;">=True)</span></span></code></pre></div><h1 id="训练模型" tabindex="-1">训练模型 <a class="header-anchor" href="#训练模型" aria-label="Permalink to &quot;训练模型&quot;">​</a></h1><h2 id="自定义模型" tabindex="-1">自定义模型 <a class="header-anchor" href="#自定义模型" aria-label="Permalink to &quot;自定义模型&quot;">​</a></h2><p>因为图片识别任务输入的图片比较简单, 所以我这儿直接用vgg16来训练一个小模型就可以了. 原版的vgg16是基于244x244的ImageNet的图片输入, 此处我通过继承调整了池化层的7x7的特征图的输入, 以让他支持32x32的输入还有最后的全连接层的输出.</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> torch</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> torch </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> nn</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> torchvision</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">models </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> vgg16</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">optim</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#A6ACCD;"> optim</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> numpy </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#A6ACCD;"> np</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">device </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">cuda</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">cuda</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">is_available</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">mps</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">backends</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">mps</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">is_available</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">cpu</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;Using </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">device</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;"> device&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">total_classes </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">list</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">set</span><span style="color:#89DDFF;">([</span><span style="color:#82AAFF;">i</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">split</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">]</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#82AAFF;"> i </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#82AAFF;"> need_move_images</span><span style="color:#89DDFF;">]))</span></span>
<span class="line"><span style="color:#A6ACCD;">total_classes_num </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">total_classes</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">## 大批量测试</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> matplotlib </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> pyplot </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#A6ACCD;"> plt</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> torchvision</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">utils </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> make_grid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VGG16_S</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">nn</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">Module</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__init__</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;font-style:italic;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">num_classes</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">super</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">VGG16_S</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">__init__</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        model </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">vgg16</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">pretrained</span><span style="color:#89DDFF;">=True)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 可以选择False 和True </span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">features</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> model</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">features</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 只取了feature</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">classifier</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Sequential</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">            nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Linear</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">512</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">4096</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;">  </span><span style="color:#676E95;font-style:italic;"># 修改此处的第一个参数用来适配64*64</span></span>
<span class="line"><span style="color:#82AAFF;">            nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ReLU</span><span style="color:#89DDFF;">(True),</span></span>
<span class="line"><span style="color:#82AAFF;">            nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Dropout</span><span style="color:#89DDFF;">(),</span></span>
<span class="line"><span style="color:#82AAFF;">            nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Linear</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">4096</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">4096</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#82AAFF;">            nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ReLU</span><span style="color:#89DDFF;">(True),</span></span>
<span class="line"><span style="color:#82AAFF;">            nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Dropout</span><span style="color:#89DDFF;">(),</span></span>
<span class="line"><span style="color:#82AAFF;">            nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Linear</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">4096</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> num_classes</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#82AAFF;">        </span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">forward</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;font-style:italic;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">x</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        x </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">features</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">x</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        x </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">view</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">size</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">        x </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">classifier</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">x</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> x</span></span></code></pre></div><h2 id="训练识别模型" tabindex="-1">训练识别模型 <a class="header-anchor" href="#训练识别模型" aria-label="Permalink to &quot;训练识别模型&quot;">​</a></h2><p>使用多个不同背景合成的训练数据和数据增强后, 我们获得了 10872 的总训练数据, 921个类. 然后就可以进行相关的训练了. (数据量实在不算太多, 所以偷懒直接回抽样训练数据验证好了)</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">%%</span><span style="color:#A6ACCD;">time</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 训练模型</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">net </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">VGG16_S</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">num_classes</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">total_classes_num</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 这次训练64 * 64的版本</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">criterion </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">CrossEntropyLoss</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">optimizer </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> optim</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Adam</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">parameters</span><span style="color:#89DDFF;">(),</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">lr</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.0001</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">weight_decay</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.01</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 加入了l2正则化</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">check_iter </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># train check batch size </span></span>
<span class="line"><span style="color:#A6ACCD;">train_epoch </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">25</span></span>
<span class="line"><span style="color:#A6ACCD;">prefix </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;20240128_full_32x32_clear_</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">total_classes_num</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">class_l2_2-&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">batch_size</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> batch_size</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> epoch </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_epoch</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">train</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 每个epoch 后切换训练模式, 那么会不会保d留之前的训练权重呢?</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    progress_bar </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tqdm</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">enumerate</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataloader</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">total</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataloader</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> data </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> progress_bar</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        inputs</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> labels </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> data  </span><span style="color:#676E95;font-style:italic;"># 必须要float 归一化? 浮点类型.</span></span>
<span class="line"><span style="color:#A6ACCD;">        inputs</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> labels </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> inputs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">float</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> labels</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        optimizer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">zero_grad</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        outputs </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">net</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">inputs</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 这一步, 运行有问题, 这是为什么呢, 检查一下图片格式</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        loss </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">criterion</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">outputs</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> labels</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        loss</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">backward</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        optimizer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">step</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        progress_bar</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">set_description</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&#39;epoch:</span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">epoch</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">, loss: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">loss </span><span style="color:#89DDFF;">/</span><span style="color:#82AAFF;"> batch_size</span><span style="color:#C792EA;">:.3f</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> epoch </span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 每两个epoch进行一次验证</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">开始验证....</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">eval</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        correct </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 记录正确预测的数量</span></span>
<span class="line"><span style="color:#A6ACCD;">        total </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 总的样本数</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">with</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">no_grad</span><span style="color:#89DDFF;">():</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span></span>
<span class="line"><span style="color:#A6ACCD;">            progress_bar2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tqdm</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">enumerate</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataloader</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">total</span><span style="color:#89DDFF;">=</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataloader</span><span style="color:#89DDFF;">)</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0.4</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> data </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> progress_bar2</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataloader</span><span style="color:#89DDFF;">)</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0.4</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#A6ACCD;">                inputs</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> labels </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> data</span></span>
<span class="line"><span style="color:#A6ACCD;">                inputs</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> labels </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> inputs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">float</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> labels</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                outputs </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">net</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">inputs</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                _</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> predicted </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">max</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">outputs</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">data</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                total </span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> labels</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">size</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 实际的样本数</span></span>
<span class="line"><span style="color:#A6ACCD;">                correct </span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">predicted </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> labels</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">sum</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">item</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 正确预测的样本数</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">        accuracy </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">round</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">correct </span><span style="color:#89DDFF;">/</span><span style="color:#82AAFF;"> total </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 计算准确率</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&#39;epoch: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">epoch</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">, Accuracy: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">accuracy</span><span style="color:#C792EA;">:.3f</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> accuracy </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">60</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 太小的根本没比较保存</span></span>
<span class="line"><span style="color:#A6ACCD;">            save_model_path </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">prefix</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">_vgg16_</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">epoch</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">_</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">accuracy</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">.pth&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">            torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">save</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">state_dict</span><span style="color:#89DDFF;">(),</span><span style="color:#82AAFF;"> save_model_path</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;model save: &quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> save_model_path</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">    torch</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">cuda</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">empty_cache</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Finished Training</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">save_model_path </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">prefix</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">_vgg16_</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">epoch</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">_</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">accuracy</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">.pth&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">save</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">state_dict</span><span style="color:#89DDFF;">(),</span><span style="color:#82AAFF;"> save_model_path</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;model save: &quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> save_model_path</span><span style="color:#89DDFF;">)</span></span></code></pre></div><h1 id="验证训练成果" tabindex="-1">验证训练成果 <a class="header-anchor" href="#验证训练成果" aria-label="Permalink to &quot;验证训练成果&quot;">​</a></h1><p>经过多次训练验证, 最终设置25epoch, 每轮保存结果后, 得到了多个90以上准确率的结果, 这之后我还让他训练了额外的10轮, 但是准确率都没有再提升,反而突下降了, 说明后续更多的epoch就是过拟合了, 不需要再增加轮数.<br> 最终我才用了16 epoch的模型结果:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">epoch: 16, Accuracy: 98.001</span></span>
<span class="line"><span style="color:#A6ACCD;">model save:  20240128_full_32x32_clear_906class_l2_2-_vgg16_16_98.001.pth</span></span></code></pre></div><h2 id="验证代码" tabindex="-1">验证代码 <a class="header-anchor" href="#验证代码" aria-label="Permalink to &quot;验证代码&quot;">​</a></h2><p>读取模型, 并且使用手机拍照的截图, 并使用真实图片进行验证:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">model_path </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">20240128_full_32x32_clear_906class_l2_2-_vgg16_16_98.001.pth</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 这个效果也不错 19, 看第一/第二个</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">model </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">VGG16_S</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">num_classes</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">total_classes_num</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">model</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">load_state_dict</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">load</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">model_path</span><span style="color:#89DDFF;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_real_label</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">class_index</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> label_dict</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">class_index</span><span style="color:#89DDFF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">eval_predict</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">model</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">image_path</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    image </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">read_image</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">image_path</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">mode</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">torchvision</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">io</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">ImageReadMode</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">RGB</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    inner_transform </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Compose</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">    </span><span style="color:#89DDFF;">[</span></span>
<span class="line"><span style="color:#82AAFF;">        transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Resize</span><span style="color:#89DDFF;">((</span><span style="color:#F78C6C;">32</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">32</span><span style="color:#89DDFF;">)),</span><span style="color:#82AAFF;"> </span></span>
<span class="line"><span style="color:#82AAFF;">        transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ColorJitter</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">            </span><span style="color:#A6ACCD;font-style:italic;">brightness</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.1</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">            </span><span style="color:#A6ACCD;font-style:italic;">contrast</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.1</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">            </span><span style="color:#A6ACCD;font-style:italic;">saturation</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.1</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">            </span><span style="color:#A6ACCD;font-style:italic;">hue</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.1</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;">  </span><span style="color:#676E95;font-style:italic;"># 抖动图像的亮度、对比度、饱和度和色相</span></span>
<span class="line"><span style="color:#82AAFF;">        transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Lambda</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">lambda</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">x</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">float</span><span style="color:#89DDFF;">()),</span></span>
<span class="line"><span style="color:#82AAFF;">        transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Normalize</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">            global_mean</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">            global_std</span></span>
<span class="line"><span style="color:#82AAFF;">        </span><span style="color:#89DDFF;">)</span><span style="color:#82AAFF;">  </span><span style="color:#676E95;font-style:italic;"># 对图片数据做正则化</span></span>
<span class="line"><span style="color:#82AAFF;">    </span><span style="color:#89DDFF;">])</span></span>
<span class="line"><span style="color:#A6ACCD;">    model</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">eval</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    timg </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">inner_transform</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">image</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    timg </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> timg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    timg1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> timg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unsqueeze</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    result </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">model</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">timg1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    _</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> predicted </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">max</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">result</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">get_real_label</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">predicted</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">item</span><span style="color:#89DDFF;">())</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> result</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> predicted```</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">## 验证结果可视化   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">推理</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> 并且得到前10个最像的类型</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> 优化用户体验</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;"> 因为训练数据有限</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> 所以才用增加召回数量和显示各个种类识别率的形式给用户选择</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">毕竟</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">本质是方便用户识别道具类型</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">```python</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">nn</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">functional</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#A6ACCD;"> F</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> PIL </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> Image</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> ImageDraw</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> ImageFont</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">real_test_images </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> os</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">listdir</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">cus_test_data/</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">find</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">real_test_images</span><span style="color:#89DDFF;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> t_image_path </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> real_test_images</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">real label: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> image_path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">split</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)[-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">])</span><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    t_image_path </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> os</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">cus_test_data</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> t_image_path</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    t_image </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Image</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">open</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">t_image_path</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    t_image </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> t_image</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resize</span><span style="color:#89DDFF;">((</span><span style="color:#F78C6C;">32</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">32</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">    result</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> predicted </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">eval_predict</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">model</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> t_image_path</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    probabilities </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> F</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">softmax</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">result</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">dim</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">    values</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> indices </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">topk</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">probabilities</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    match_images </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">t_image</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> p</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">zip</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">values</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">].</span><span style="color:#82AAFF;">tolist</span><span style="color:#89DDFF;">(),</span><span style="color:#82AAFF;"> indices</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">].</span><span style="color:#82AAFF;">tolist</span><span style="color:#89DDFF;">()):</span></span>
<span class="line"><span style="color:#A6ACCD;">        data </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_real_label</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">i</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;</span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">data</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">en</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;"> </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">data</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">zh</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">round</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;">p</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">)</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">%&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        match_img </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Image</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">open</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">data</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">image</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># 创建一个可以在给定图像上绘图的对象</span></span>
<span class="line"><span style="color:#A6ACCD;">        draw </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ImageDraw</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Draw</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">match_img</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># 字体颜色</span></span>
<span class="line"><span style="color:#A6ACCD;">        font_color </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">232</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">98</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">85</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># 绘制文本</span></span>
<span class="line"><span style="color:#A6ACCD;">        draw</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">text</span><span style="color:#89DDFF;">((</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;</span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">round</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;">p</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">%&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">fill</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">font_color</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        match_images</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">append</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">match_img</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">plot_images</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">match_images</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">figsize</span><span style="color:#89DDFF;">=(</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">----------------------------------------------</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span></code></pre></div><p><img src="/assets/自定义训练数据图像识别-验证真实结果-2024-01-29.6019a0bc.png" alt=""><img src="/assets/自定义训练数据图像识别-结果可视化-2024-01-29.4d7759a1.png" alt=""><img src="/assets/自定义训练数据图像识别-结果总结-2024-01-29.6146e566.png" alt=""></p><h1 id="换用resnet网络训练对比" tabindex="-1">换用ResNet网络训练对比 <a class="header-anchor" href="#换用resnet网络训练对比" aria-label="Permalink to &quot;换用ResNet网络训练对比&quot;">​</a></h1><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">%%</span><span style="color:#A6ACCD;">time</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 训练模型</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 加载ResNet101模型</span></span>
<span class="line"><span style="color:#A6ACCD;">net </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> torchvision</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">models</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resnet101</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">pretrained</span><span style="color:#89DDFF;">=True)</span></span>
<span class="line"><span style="color:#A6ACCD;">num_features </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> net</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">fc</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">in_features</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 增加 dropout</span></span>
<span class="line"><span style="color:#A6ACCD;">net</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">fc</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Sequential</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">    torch</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Dropout</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0.5</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;">   </span><span style="color:#676E95;font-style:italic;"># 增加 dropout避免太快过拟合</span></span>
<span class="line"><span style="color:#82AAFF;">    torch</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Linear</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">num_features</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> total_classes_num</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 单层卷积, 替代了vgg的4096个全连接层,深,但是速度还更快</span></span>
<span class="line"><span style="color:#A6ACCD;">net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">model</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">eval</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 验证模块</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">criterion </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">CrossEntropyLoss</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">optimizer </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> optim</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Adam</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">parameters</span><span style="color:#89DDFF;">(),</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">lr</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.0001</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">weight_decay</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.01</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 加入了l2正则化</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">check_iter </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># train check batch size </span></span>
<span class="line"><span style="color:#A6ACCD;">train_epoch </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">25</span></span>
<span class="line"><span style="color:#A6ACCD;">prefix </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;20240201_full_32x32_clear_</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">total_classes_num</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">class_l2_2-&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">batch_size</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> batch_size</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> epoch </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_epoch</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">train</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 每个epoch 后切换训练模式, 那么会不会保d留之前的训练权重呢?</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    progress_bar </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tqdm</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">enumerate</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataloader</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">total</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataloader</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> data </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> progress_bar</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        inputs</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> labels </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> data  </span><span style="color:#676E95;font-style:italic;"># 必须要float 归一化? 浮点类型.</span></span>
<span class="line"><span style="color:#A6ACCD;">        inputs</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> labels </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> inputs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">float</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> labels</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        optimizer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">zero_grad</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        outputs </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">net</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">inputs</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 这一步, 运行有问题, 这是为什么呢, 检查一下图片格式</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        loss </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">criterion</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">outputs</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> labels</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        loss</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">backward</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        optimizer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">step</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        progress_bar</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">set_description</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&#39;epoch:</span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">epoch</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">, loss: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">loss </span><span style="color:#89DDFF;">/</span><span style="color:#82AAFF;"> batch_size</span><span style="color:#C792EA;">:.3f</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> epoch </span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 每两个epoch进行一次验证</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">开始验证....</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">eval</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        correct </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 记录正确预测的数量</span></span>
<span class="line"><span style="color:#A6ACCD;">        total </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 总的样本数</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">with</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">no_grad</span><span style="color:#89DDFF;">():</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span></span>
<span class="line"><span style="color:#A6ACCD;">            progress_bar2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tqdm</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">enumerate</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataloader</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">total</span><span style="color:#89DDFF;">=</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataloader</span><span style="color:#89DDFF;">)</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0.4</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> data </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> progress_bar2</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataloader</span><span style="color:#89DDFF;">)</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0.4</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#A6ACCD;">                inputs</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> labels </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> data</span></span>
<span class="line"><span style="color:#A6ACCD;">                inputs</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> labels </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> inputs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">float</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> labels</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                outputs </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">net</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">inputs</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                _</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> predicted </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">max</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">outputs</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">data</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                total </span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> labels</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">size</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 实际的样本数</span></span>
<span class="line"><span style="color:#A6ACCD;">                correct </span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">predicted </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> labels</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">sum</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">item</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 正确预测的样本数</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">        accuracy </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">round</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">correct </span><span style="color:#89DDFF;">/</span><span style="color:#82AAFF;"> total </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 计算准确率</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&#39;epoch: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">epoch</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">, Accuracy: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">accuracy</span><span style="color:#C792EA;">:.3f</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> accuracy </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">60</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 太小的根本没比较保存</span></span>
<span class="line"><span style="color:#A6ACCD;">            save_model_path </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">prefix</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">_resnet101_</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">epoch</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">_</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">accuracy</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">.pth&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">            torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">save</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">state_dict</span><span style="color:#89DDFF;">(),</span><span style="color:#82AAFF;"> save_model_path</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;model save: &quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> save_model_path</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">    torch</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">cuda</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">empty_cache</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Finished Training</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">save_model_path </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">prefix</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">_resnet101_</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">epoch</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">_</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">accuracy</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">.pth&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">save</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">state_dict</span><span style="color:#89DDFF;">(),</span><span style="color:#82AAFF;"> save_model_path</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;model save: &quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> save_model_path</span><span style="color:#89DDFF;">)</span></span></code></pre></div><h2 id="resnet模型验证" tabindex="-1">ResNet模型验证 <a class="header-anchor" href="#resnet模型验证" aria-label="Permalink to &quot;ResNet模型验证&quot;">​</a></h2><p>得益于<code>ResNet</code>采用了跳跃链接, 损失值能够更好的在更深的网络中进行传递, 表现的效果就是训练更容易收敛了.</p><p>训练的输出如下, 可以看到resnet的收敛速度极快, 10个epoch以内就可以达到90%的准确率,, 而vggNet则要接近10个epoch是远远没法达到90%准确率的.<br> ResNet准确性更高, 所以如果是实际应用产品的话, 可以直接不用管古老的历史包袱了, vgg当然也有它的标志性意义. 但是真实省事, 确实直接选模型挑选新一点的, 会少一些坑. 🤔</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">epoch:4,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">loss:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0.005</span><span style="color:#C3E88D;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">100</span><span style="color:#C3E88D;">%</span><span style="color:#89DDFF;">|</span><span style="color:#FFCB6B;">███████████████████████████████████████████████████████████████████████████████████████████████████████</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">85/85</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">02</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">45</span><span style="color:#89DDFF;">&lt;</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">,  1.95s/it</span><span style="color:#89DDFF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">开始验证.</span><span style="color:#82AAFF;">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">%</span><span style="color:#89DDFF;">|</span><span style="color:#FFCB6B;">█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">34/34</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">17</span><span style="color:#89DDFF;">&lt;</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">,  1.90it/s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">epoch:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#C3E88D;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Accuracy:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">96.507</span></span>
<span class="line"><span style="color:#FFCB6B;">model</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">save:</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">20240201_full_32x32_clear_906class_l2_2-_resnet101_4_96.507.pth</span></span></code></pre></div><p>载入训练后模型, 使用上面vgg16验证的代码, 进行验证, 对比后发现, 整体的泛化能力, ResNet要更好, 很多VggNet没能稳定识别的验证图片, ResNet都能比较稳定的以比较高的识别率进行识别.</p><h1 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h1><p>一时兴起的小需求, 也很多小细节需要处理. 大批量数据运行前, 需要先抽少一些类进行小批量的快速验证, 对模型和训练数据进行验证. 这次我就是先用20类进行验证, 之后才进行900多类的训练.</p><p>一开始用vgg, 用的是224x224的图片输入, 后面为了提速.因为是像素画,只要不要平滑, 32x32也足够清晰, 所以就调整vgg结构, 方便进行增加更多的batch_size进行更快的训练.及时调整了输入图片的尺寸以后, 我的电脑训练起来也快了很多, 40多分钟就可以完成25轮 128batch_size的模型训练, 体验还不错!</p><p>然后就是, 可以的话, 主动挑选更新的代码, 老的模型, 经典, 但是效果远不如新一些的模型.ResNet更快收敛, 更快训练(笑...)</p><p><a href="https://github.com/realzhengyiming/isaac_tools/blob/main/simple_issac_item_recognition-%E5%85%A8%E9%87%8F%E8%AE%AD%E7%BB%83%E7%9A%84%E7%89%88%E6%9C%AC.ipynb" target="_blank" rel="noreferrer">模型训练完整代码</a><br><a href="https://github.com/realzhengyiming/isaac_tools/blob/main/isaac_data_spider.py" target="_blank" rel="noreferrer">数据获取和处理的完整代码</a> 代码都在github上了.<br> 我要去玩游戏了, 以撒真好玩 : )</p><h2 id="后续优化" tabindex="-1">后续优化 <a class="header-anchor" href="#后续优化" aria-label="Permalink to &quot;后续优化&quot;">​</a></h2><ul><li>增加一下真实的截图作为训练数据, 以进一步提高各个类别的准确度</li><li>进一步增加一些其他的数据增强, 以更好的模拟真实的使用情况</li></ul><ul><li>[x] 考虑换用其他模型(resnet替换验证, 改进的模型明显更好, 历史包袱应该早日丢弃.)</li></ul><ul><li>部署模型到移动端, 封装成应用进行使用, 改训练目标检测模型.</li></ul></div></div></main><!----><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter" data-v-2bf54a99 data-v-3d1b5f7c><div class="container" data-v-3d1b5f7c><p class="message" data-v-3d1b5f7c>2024 - future</p><p class="copyright" data-v-3d1b5f7c>我在练习生活</p></div></footer><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"blog_archives.md\":\"623bcfb1\",\"blog_index.md\":\"6f622db4\",\"blog_authors_yi-ming.md\":\"72970469\",\"blog_posts_2024_vitepress_obsidian.md\":\"b7e2110e\",\"blog_tags.md\":\"62e1cd9b\",\"index.md\":\"3cf96156\",\"blog_posts_2024_llm_agent.md\":\"c277315c\",\"unpost_blog_gpt-sovits.md\":\"603b8d35\",\"unpost_blog_rag_enhance.md\":\"f9ba498a\",\"blog_posts_2024_latest-llm-model-fine-tune.md\":\"f2e579b3\",\"blog_posts_2024_ollama_local_inference_summary_generation_capability.md\":\"5e3bf348\",\"blog_posts_2024_isaac_image_recognition.md\":\"9fd3c83f\",\"blog_posts_2024_vitepress_use_vue_animation.md\":\"b70daf99\"}")
__VP_SITE_DATA__ = JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"YiMing's blog\",\"description\":\"A balanced life, coding for enjoyment\",\"base\":\"/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"logo\":\"yiminglogo2.png\",\"siteTitle\":\"YiMing's Blog\",\"footer\":{\"message\":\"2024 - future\",\"copyright\":\"我在练习生活\"},\"blog\":{\"title\":\"博文\",\"description\":\"✍️\",\"defaultAuthor\":\"YiMing\",\"categoryIcons\":{\"article\":\"i-[heroicons-outline/book-open]\",\"tutorial\":\"i-[heroicons-outline/academic-cap]\",\"document\":\"i-[heroicons-outline/annotation]\"},\"tagIcons\":{\"github\":\"i-[carbon/logo-github]\",\"vue\":\"i-[carbon/logo-vue]\"}},\"search\":{\"provider\":\"local\"},\"nav\":[{\"text\":\"Home\",\"link\":\"/\"},{\"text\":\"Blog\",\"items\":[{\"text\":\"Blog Home\",\"link\":\"/blog/\",\"activeMatch\":\"/blog/$\"},{\"text\":\"Tags\",\"link\":\"/blog/tags\",\"activeMatch\":\"/blog/tags\"},{\"text\":\"Archives\",\"link\":\"/blog/archives\",\"activeMatch\":\"/blog/archives\"}]},{\"text\":\"About\",\"link\":\"/blog/authors/yi-ming\"}],\"sidebar\":[{\"text\":\"Examples\",\"items\":[{\"text\":\"Markdown Examples\",\"link\":\"/markdown-examples\"},{\"text\":\"Runtime API Examples\",\"link\":\"/api-examples\"}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/realzhengyiming\"}]},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}")</script>
    
  </body>
</html>