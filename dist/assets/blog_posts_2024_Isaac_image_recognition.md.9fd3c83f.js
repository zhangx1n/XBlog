import{_ as l,c as p,I as o,C as s,a,V as e,o as t,J as c}from"./chunks/framework.41330901.js";const F="/assets/自定义训练数据图像识别-2024-01-29.a602417e.png",r="/assets/自定义训练数据图像识别-像素风格-2024-01-29.4b132729.png",D="/assets/自定义训练数据图像识别-数据合成多背景-2024-01-29.0f002570.png",y="/assets/自定义训练数据图像识别-验证真实结果-2024-01-29.6019a0bc.png",A="/assets/自定义训练数据图像识别-结果可视化-2024-01-29.4d7759a1.png",C="/assets/自定义训练数据图像识别-结果总结-2024-01-29.6146e566.png",B=JSON.parse('{"title":"以撒道具/饰品图像识别","description":"自定义训练数据的以撒道具图像识别, 《以撒的结合》训练数据道具装备识别","frontmatter":{"title":"以撒道具/饰品图像识别","time":877,"description":"自定义训练数据的以撒道具图像识别, 《以撒的结合》训练数据道具装备识别","navbar":true,"sidebar":false,"footer":true,"date":"2024-01-29T00:00:00.000Z","category":"Tutorial","author":"Yi Ming","next":false,"tags":["深度学习","图像识别","以撒的结合"],"blog":"post","aside":"left","prev":false},"headers":[],"relativePath":"blog/posts/2024/Isaac_image_recognition.md"}'),i={name:"blog/posts/2024/Isaac_image_recognition.md"},f=s("h1",{id:"引言",tabindex:"-1"},[a("引言 "),s("a",{class:"header-anchor",href:"#引言","aria-label":'Permalink to "引言"'},"​")],-1),_=s("p",null,[s("img",{src:F,alt:""}),a(" 最近在玩《以撒的结合:忏悔》, ns版本. 游戏确实上头好玩, 内容很多. 但是游玩下来遇到一个纠结头疼的问题就是, 道具/ 装备 有时候捡起来后的效果, 还不如不捡. 装备/道具只会在捡起来的时候才能看到道具和状态是什么, 甚至, 有时候捡起来后描述也看不出这个道具到底能用来干嘛, 魂系叙事那一套......虽然也找到不错的"),s("a",{href:"https://isaac.huijiwiki.com/wiki/%E9%A6%96%E9%A1%B5",target:"_blank",rel:"noreferrer"},"以撒的结合中文维基"),a(", 但是, 站点只能文字搜索, 再加上其道具和饰品加起来总数量有900多个, 相当于ImageNet的种类了. 于是就想到, 干脆做一个"),s("strong",null,"以撒道具图像识别功能"),a(" 好了, 优化体验: ) .")],-1),d=s("hr",null,null,-1),m=e(`<h1 id="自定义训练数据图像识别" tabindex="-1">自定义训练数据图像识别 <a class="header-anchor" href="#自定义训练数据图像识别" aria-label="Permalink to &quot;自定义训练数据图像识别&quot;">​</a></h1><p>得益于各种深度学习框架的发展, 现在训练一个模型变得非常简单, 于是我就决定直接用<code>pytorch</code>来完成这个图片识别的任务了. 考虑到以撒的道具装备这类东西图像数据是非常<strong>垂直领域</strong>了, 所以我需要准备对应的训练数据进行模型的训练.</p><h1 id="数据准备" tabindex="-1">数据准备 <a class="header-anchor" href="#数据准备" aria-label="Permalink to &quot;数据准备&quot;">​</a></h1><h2 id="数据获取-数据合成" tabindex="-1">数据获取&amp;数据合成 <a class="header-anchor" href="#数据获取-数据合成" aria-label="Permalink to &quot;数据获取&amp;数据合成&quot;">​</a></h2><p>从<a href="https://isaac.huijiwiki.com/wiki/%E9%A6%96%E9%A1%B5" target="_blank" rel="noreferrer">以撒的结合中文维基</a> 编写爬虫把道具/装备的图片数据, 描述都抓取下来.<br> 爬虫比较简单, 主要就是图片爬取的时候, 需要从css中把sprite图子图的x, y提取出来, 然后自行使用sprite划分独立的道具图. 下图为css和html标签中抽取出来的信息</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">collectibles_001</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">x</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">32</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">y</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">en</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">The Sad Onion</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">zh</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">悲伤洋葱</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">level</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">1</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">type</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">道具</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">level2</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">3</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">?</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">desc</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">射速上升。</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">new_id</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">image</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./cus_data/0.png</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">},</span><span style="color:#A6ACCD;"> ...</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 提取出每个道具的图片和其他属性</span></span></code></pre></div><p>然后把图片分割后某个目录, 此处我是把裁切好的图片存放在 <code>./cus_data</code>下. 并且把图片. 整理后得到训练的类别标签备用.</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&gt;&gt;&gt;</span><span style="color:#A6ACCD;">classes</span></span>
<span class="line"><span style="color:#89DDFF;">{</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">悲伤洋葱:射速上升。</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">内眼:角色每次发射3颗泪弹。</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">弯勺魔术:角色的泪弹获得追踪效果。</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">柯吉猫的头:泪弹变大，击退效果上升，伤害上升。</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">我的镜像:角色的泪弹会飞回角色身边。</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">小号:射程下降，射速上升。</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> ...</span></span></code></pre></div><p>此处我把图片裁剪下来的32x32大小的图片保存为合成训练数据的元数据, 因为是像素风格, 所以哪怕所缩小了,只要不使用平滑, 那还是非常清晰的. <img src="`+r+'" alt=""><br> (数据获得和处理完整代码在末尾的引用中会给出链接.)</p><h2 id="数据增强" tabindex="-1">数据增强 <a class="header-anchor" href="#数据增强" aria-label="Permalink to &quot;数据增强&quot;">​</a></h2><p>实际的预测情况都伴随着各种各样的背景干扰, 所以这边需要在合成训练数据的时候, 也需要让这些元图标拥有各种各样的背景. <img src="'+D+`" alt=""> 另一方面, 考虑到一个场景就是使用摄像头的拍照的时候, 可能会有的一些图像的畸变和变形等. transform中也需要配置数据增强的操作, 包括但不限于, 抖动, 明暗度变化等.</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> torchvision</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">transforms </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> ToTensor</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">transform </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Compose</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">    </span><span style="color:#89DDFF;">[</span></span>
<span class="line"><span style="color:#82AAFF;">        transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Lambda</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">lambda</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">x</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">float</span><span style="color:#89DDFF;">()),</span></span>
<span class="line"><span style="color:#82AAFF;">    </span><span style="color:#89DDFF;">])</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 先直接配置一个用来计算 数据均值和标准差,以方便正则化</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 配置初始的dataloader用于遍历和计算均值和标准差</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> torchvision</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">io </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> read_image</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">IssacCustomDatasets</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Dataset</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__init__</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;font-style:italic;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">img_sort_files</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">                 </span><span style="color:#A6ACCD;font-style:italic;">img_dir</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">transform</span><span style="color:#89DDFF;">=None,</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#A6ACCD;font-style:italic;">target_transform</span><span style="color:#89DDFF;">=None):</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">img_labels</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> img_sort_files</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># 自定义标签关系, 此处需要排好序的</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">img_dir</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> img_dir</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">transform</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> transform</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">target_transform</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> target_transform</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__len__</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;font-style:italic;">self</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">img_labels</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__getitem__</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;font-style:italic;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">idx</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 作用是获得label 和 item 即可</span></span>
<span class="line"><span style="color:#A6ACCD;">        filename </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">img_labels</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">idx</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">        img_path </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> os</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">img_dir</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> filename</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        image </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">read_image</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">img_path</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">mode</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">torchvision</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">io</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">ImageReadMode</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">RGB</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        label </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">filename</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">split</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">])</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">transform</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">            image </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">transform</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">image</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">target_transform</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">            label </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">target_transform</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">label</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> image</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> label</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">from_dir </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">new_cus_data</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">need_move_images </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> os</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">listdir</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">new_cus_data/</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">need_move_images </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> need_move_images </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">i</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">split</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">])</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">need_move_images</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sort</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">key</span><span style="color:#89DDFF;">=</span><span style="color:#C792EA;">lambda</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">x</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;</span><span style="color:#F78C6C;">{</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">split</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">])</span><span style="color:#C792EA;">:03d</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&quot;</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">+</span><span style="color:#82AAFF;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;</span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">split</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">need_move_images</span><span style="color:#89DDFF;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">train_dataset </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IssacCustomDatasets</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">img_sort_files</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">need_move_images</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">img_dir</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">new_cus_data/</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">                                    </span><span style="color:#A6ACCD;font-style:italic;">transform</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">transform</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">## dataloader</span></span>
<span class="line"><span style="color:#A6ACCD;">train_dataloader </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">DataLoader</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataset</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span></span>
<span class="line"><span style="color:#82AAFF;">                              </span><span style="color:#A6ACCD;font-style:italic;">batch_size</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">batch_size</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span></span>
<span class="line"><span style="color:#82AAFF;">                              </span><span style="color:#A6ACCD;font-style:italic;">shuffle</span><span style="color:#89DDFF;">=True)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 获取图片数据的 归一化数值</span></span>
<span class="line"><span style="color:#A6ACCD;">global_mean </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[]</span></span>
<span class="line"><span style="color:#A6ACCD;">global_std </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[]</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> images</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> labels </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> train_dataloader</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    numpy_image </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> images</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">numpy</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    batch_mean </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> np</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">mean</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">numpy_image</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">axis</span><span style="color:#89DDFF;">=(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">    batch_std </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> np</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">std</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">numpy_image</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">axis</span><span style="color:#89DDFF;">=(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">    global_mean</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">append</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">batch_mean</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    global_std</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">append</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">batch_std</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">global_mean </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> np</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">mean</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">global_mean</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">axis</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">tolist</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">global_std </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> np</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">mean</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">global_std</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">axis</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">tolist</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">global_mean</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">global_std</span><span style="color:#89DDFF;">)</span></span></code></pre></div><p>再次根据得到的均值和标准差更新训练用的dataloader</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> torchvision</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">transforms </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> ToTensor</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">transform </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Compose</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">    </span><span style="color:#89DDFF;">[</span></span>
<span class="line"><span style="color:#82AAFF;">        transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">RandomAffine</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">degrees</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">translate</span><span style="color:#89DDFF;">=None,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">scale</span><span style="color:#89DDFF;">=(</span><span style="color:#F78C6C;">0.9</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1.1</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">shear</span><span style="color:#89DDFF;">=None),</span><span style="color:#82AAFF;">  </span></span>
<span class="line"><span style="color:#82AAFF;">        </span><span style="color:#676E95;font-style:italic;"># 随机放大或者缩小一点点</span></span>
<span class="line"><span style="color:#82AAFF;">        </span><span style="color:#676E95;font-style:italic;"># 增加噪声, 防止过拟合</span></span>
<span class="line"><span style="color:#82AAFF;">        transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ColorJitter</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">            </span><span style="color:#A6ACCD;font-style:italic;">brightness</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.1</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">            </span><span style="color:#A6ACCD;font-style:italic;">contrast</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.1</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">            </span><span style="color:#A6ACCD;font-style:italic;">saturation</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.1</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">            </span><span style="color:#A6ACCD;font-style:italic;">hue</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.1</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;">  </span><span style="color:#676E95;font-style:italic;"># 抖动图像的亮度、对比度、饱和度和色相</span></span>
<span class="line"><span style="color:#82AAFF;">        transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Lambda</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">lambda</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">x</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">float</span><span style="color:#89DDFF;">()),</span></span>
<span class="line"><span style="color:#82AAFF;">        transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Normalize</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">            global_mean</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">            global_std</span></span>
<span class="line"><span style="color:#82AAFF;">        </span><span style="color:#89DDFF;">)</span><span style="color:#82AAFF;">  </span><span style="color:#676E95;font-style:italic;"># 对图片数据做正则化</span></span>
<span class="line"><span style="color:#82AAFF;">    </span><span style="color:#89DDFF;">])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">train_dataset </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IssacCustomDatasets</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">need_move_images</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">img_dir</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">new_cus_data/</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">transform</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">transform</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">## dataloader</span></span>
<span class="line"><span style="color:#A6ACCD;">train_dataloader </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">DataLoader</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataset</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span></span>
<span class="line"><span style="color:#82AAFF;">                              </span><span style="color:#A6ACCD;font-style:italic;">batch_size</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">batch_size</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span></span>
<span class="line"><span style="color:#82AAFF;">                              </span><span style="color:#A6ACCD;font-style:italic;">shuffle</span><span style="color:#89DDFF;">=True)</span></span></code></pre></div><h1 id="训练模型" tabindex="-1">训练模型 <a class="header-anchor" href="#训练模型" aria-label="Permalink to &quot;训练模型&quot;">​</a></h1><h2 id="自定义模型" tabindex="-1">自定义模型 <a class="header-anchor" href="#自定义模型" aria-label="Permalink to &quot;自定义模型&quot;">​</a></h2><p>因为图片识别任务输入的图片比较简单, 所以我这儿直接用vgg16来训练一个小模型就可以了. 原版的vgg16是基于244x244的ImageNet的图片输入, 此处我通过继承调整了池化层的7x7的特征图的输入, 以让他支持32x32的输入还有最后的全连接层的输出.</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> torch</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> torch </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> nn</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> torchvision</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">models </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> vgg16</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">optim</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#A6ACCD;"> optim</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> numpy </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#A6ACCD;"> np</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">device </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">cuda</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">cuda</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">is_available</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">mps</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">backends</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">mps</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">is_available</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">cpu</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;Using </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">device</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;"> device&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">total_classes </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">list</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">set</span><span style="color:#89DDFF;">([</span><span style="color:#82AAFF;">i</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">split</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">]</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#82AAFF;"> i </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#82AAFF;"> need_move_images</span><span style="color:#89DDFF;">]))</span></span>
<span class="line"><span style="color:#A6ACCD;">total_classes_num </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">total_classes</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">## 大批量测试</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> matplotlib </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> pyplot </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#A6ACCD;"> plt</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> torchvision</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">utils </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> make_grid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VGG16_S</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">nn</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">Module</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__init__</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;font-style:italic;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">num_classes</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">super</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">VGG16_S</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">__init__</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        model </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">vgg16</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">pretrained</span><span style="color:#89DDFF;">=True)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 可以选择False 和True </span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">features</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> model</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">features</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 只取了feature</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">classifier</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Sequential</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">            nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Linear</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">512</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">4096</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;">  </span><span style="color:#676E95;font-style:italic;"># 修改此处的第一个参数用来适配64*64</span></span>
<span class="line"><span style="color:#82AAFF;">            nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ReLU</span><span style="color:#89DDFF;">(True),</span></span>
<span class="line"><span style="color:#82AAFF;">            nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Dropout</span><span style="color:#89DDFF;">(),</span></span>
<span class="line"><span style="color:#82AAFF;">            nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Linear</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">4096</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">4096</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#82AAFF;">            nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ReLU</span><span style="color:#89DDFF;">(True),</span></span>
<span class="line"><span style="color:#82AAFF;">            nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Dropout</span><span style="color:#89DDFF;">(),</span></span>
<span class="line"><span style="color:#82AAFF;">            nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Linear</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">4096</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> num_classes</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#82AAFF;">        </span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">forward</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;font-style:italic;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">x</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        x </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">features</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">x</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        x </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">view</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">size</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">        x </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">classifier</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">x</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> x</span></span></code></pre></div><h2 id="训练识别模型" tabindex="-1">训练识别模型 <a class="header-anchor" href="#训练识别模型" aria-label="Permalink to &quot;训练识别模型&quot;">​</a></h2><p>使用多个不同背景合成的训练数据和数据增强后, 我们获得了 10872 的总训练数据, 921个类. 然后就可以进行相关的训练了. (数据量实在不算太多, 所以偷懒直接回抽样训练数据验证好了)</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">%%</span><span style="color:#A6ACCD;">time</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 训练模型</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">net </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">VGG16_S</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">num_classes</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">total_classes_num</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 这次训练64 * 64的版本</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">criterion </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">CrossEntropyLoss</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">optimizer </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> optim</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Adam</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">parameters</span><span style="color:#89DDFF;">(),</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">lr</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.0001</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">weight_decay</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.01</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 加入了l2正则化</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">check_iter </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># train check batch size </span></span>
<span class="line"><span style="color:#A6ACCD;">train_epoch </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">25</span></span>
<span class="line"><span style="color:#A6ACCD;">prefix </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;20240128_full_32x32_clear_</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">total_classes_num</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">class_l2_2-&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">batch_size</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> batch_size</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> epoch </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_epoch</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">train</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 每个epoch 后切换训练模式, 那么会不会保d留之前的训练权重呢?</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    progress_bar </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tqdm</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">enumerate</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataloader</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">total</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataloader</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> data </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> progress_bar</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        inputs</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> labels </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> data  </span><span style="color:#676E95;font-style:italic;"># 必须要float 归一化? 浮点类型.</span></span>
<span class="line"><span style="color:#A6ACCD;">        inputs</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> labels </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> inputs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">float</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> labels</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        optimizer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">zero_grad</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        outputs </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">net</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">inputs</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 这一步, 运行有问题, 这是为什么呢, 检查一下图片格式</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        loss </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">criterion</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">outputs</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> labels</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        loss</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">backward</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        optimizer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">step</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        progress_bar</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">set_description</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&#39;epoch:</span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">epoch</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">, loss: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">loss </span><span style="color:#89DDFF;">/</span><span style="color:#82AAFF;"> batch_size</span><span style="color:#C792EA;">:.3f</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> epoch </span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 每两个epoch进行一次验证</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">开始验证....</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">eval</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        correct </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 记录正确预测的数量</span></span>
<span class="line"><span style="color:#A6ACCD;">        total </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 总的样本数</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">with</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">no_grad</span><span style="color:#89DDFF;">():</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span></span>
<span class="line"><span style="color:#A6ACCD;">            progress_bar2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tqdm</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">enumerate</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataloader</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">total</span><span style="color:#89DDFF;">=</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataloader</span><span style="color:#89DDFF;">)</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0.4</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> data </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> progress_bar2</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataloader</span><span style="color:#89DDFF;">)</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0.4</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#A6ACCD;">                inputs</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> labels </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> data</span></span>
<span class="line"><span style="color:#A6ACCD;">                inputs</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> labels </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> inputs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">float</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> labels</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                outputs </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">net</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">inputs</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                _</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> predicted </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">max</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">outputs</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">data</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                total </span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> labels</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">size</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 实际的样本数</span></span>
<span class="line"><span style="color:#A6ACCD;">                correct </span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">predicted </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> labels</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">sum</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">item</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 正确预测的样本数</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">        accuracy </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">round</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">correct </span><span style="color:#89DDFF;">/</span><span style="color:#82AAFF;"> total </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 计算准确率</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&#39;epoch: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">epoch</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">, Accuracy: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">accuracy</span><span style="color:#C792EA;">:.3f</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> accuracy </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">60</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 太小的根本没比较保存</span></span>
<span class="line"><span style="color:#A6ACCD;">            save_model_path </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">prefix</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">_vgg16_</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">epoch</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">_</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">accuracy</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">.pth&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">            torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">save</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">state_dict</span><span style="color:#89DDFF;">(),</span><span style="color:#82AAFF;"> save_model_path</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;model save: &quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> save_model_path</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">    torch</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">cuda</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">empty_cache</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Finished Training</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">save_model_path </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">prefix</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">_vgg16_</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">epoch</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">_</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">accuracy</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">.pth&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">save</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">state_dict</span><span style="color:#89DDFF;">(),</span><span style="color:#82AAFF;"> save_model_path</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;model save: &quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> save_model_path</span><span style="color:#89DDFF;">)</span></span></code></pre></div><h1 id="验证训练成果" tabindex="-1">验证训练成果 <a class="header-anchor" href="#验证训练成果" aria-label="Permalink to &quot;验证训练成果&quot;">​</a></h1><p>经过多次训练验证, 最终设置25epoch, 每轮保存结果后, 得到了多个90以上准确率的结果, 这之后我还让他训练了额外的10轮, 但是准确率都没有再提升,反而突下降了, 说明后续更多的epoch就是过拟合了, 不需要再增加轮数.<br> 最终我才用了16 epoch的模型结果:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">epoch: 16, Accuracy: 98.001</span></span>
<span class="line"><span style="color:#A6ACCD;">model save:  20240128_full_32x32_clear_906class_l2_2-_vgg16_16_98.001.pth</span></span></code></pre></div><h2 id="验证代码" tabindex="-1">验证代码 <a class="header-anchor" href="#验证代码" aria-label="Permalink to &quot;验证代码&quot;">​</a></h2><p>读取模型, 并且使用手机拍照的截图, 并使用真实图片进行验证:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">model_path </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">20240128_full_32x32_clear_906class_l2_2-_vgg16_16_98.001.pth</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 这个效果也不错 19, 看第一/第二个</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">model </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">VGG16_S</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">num_classes</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">total_classes_num</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">model</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">load_state_dict</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">load</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">model_path</span><span style="color:#89DDFF;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_real_label</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">class_index</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> label_dict</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">class_index</span><span style="color:#89DDFF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">eval_predict</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">model</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">image_path</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    image </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">read_image</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">image_path</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">mode</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">torchvision</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">io</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">image</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">ImageReadMode</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">RGB</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    inner_transform </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Compose</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">    </span><span style="color:#89DDFF;">[</span></span>
<span class="line"><span style="color:#82AAFF;">        transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Resize</span><span style="color:#89DDFF;">((</span><span style="color:#F78C6C;">32</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">32</span><span style="color:#89DDFF;">)),</span><span style="color:#82AAFF;"> </span></span>
<span class="line"><span style="color:#82AAFF;">        transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ColorJitter</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">            </span><span style="color:#A6ACCD;font-style:italic;">brightness</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.1</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">            </span><span style="color:#A6ACCD;font-style:italic;">contrast</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.1</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">            </span><span style="color:#A6ACCD;font-style:italic;">saturation</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.1</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">            </span><span style="color:#A6ACCD;font-style:italic;">hue</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.1</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;">  </span><span style="color:#676E95;font-style:italic;"># 抖动图像的亮度、对比度、饱和度和色相</span></span>
<span class="line"><span style="color:#82AAFF;">        transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Lambda</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">lambda</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">x</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">float</span><span style="color:#89DDFF;">()),</span></span>
<span class="line"><span style="color:#82AAFF;">        transforms</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Normalize</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">            global_mean</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">            global_std</span></span>
<span class="line"><span style="color:#82AAFF;">        </span><span style="color:#89DDFF;">)</span><span style="color:#82AAFF;">  </span><span style="color:#676E95;font-style:italic;"># 对图片数据做正则化</span></span>
<span class="line"><span style="color:#82AAFF;">    </span><span style="color:#89DDFF;">])</span></span>
<span class="line"><span style="color:#A6ACCD;">    model</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">eval</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    timg </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">inner_transform</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">image</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    timg </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> timg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    timg1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> timg</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">unsqueeze</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    result </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">model</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">timg1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    _</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> predicted </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">max</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">result</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">get_real_label</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">predicted</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">item</span><span style="color:#89DDFF;">())</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> result</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> predicted\`\`\`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">## 验证结果可视化   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">推理</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> 并且得到前10个最像的类型</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> 优化用户体验</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;"> 因为训练数据有限</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> 所以才用增加召回数量和显示各个种类识别率的形式给用户选择</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">毕竟</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">本质是方便用户识别道具类型</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">\`\`\`python</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">nn</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">functional</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#A6ACCD;"> F</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> PIL </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> Image</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> ImageDraw</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> ImageFont</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">real_test_images </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> os</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">listdir</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">cus_test_data/</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">find</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">real_test_images</span><span style="color:#89DDFF;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> t_image_path </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> real_test_images</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">real label: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> image_path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">split</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)[-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">])</span><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    t_image_path </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> os</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">join</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">cus_test_data</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> t_image_path</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    t_image </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Image</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">open</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">t_image_path</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    t_image </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> t_image</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resize</span><span style="color:#89DDFF;">((</span><span style="color:#F78C6C;">32</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">32</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">    result</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> predicted </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">eval_predict</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">model</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> t_image_path</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    probabilities </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> F</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">softmax</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">result</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">dim</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">    values</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> indices </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">topk</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">probabilities</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    match_images </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">t_image</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> p</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">zip</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">values</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">].</span><span style="color:#82AAFF;">tolist</span><span style="color:#89DDFF;">(),</span><span style="color:#82AAFF;"> indices</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">].</span><span style="color:#82AAFF;">tolist</span><span style="color:#89DDFF;">()):</span></span>
<span class="line"><span style="color:#A6ACCD;">        data </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_real_label</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">i</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;</span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">data</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">en</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;"> </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">data</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">zh</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">round</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;">p</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">)</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">%&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        match_img </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Image</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">open</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">data</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">image</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># 创建一个可以在给定图像上绘图的对象</span></span>
<span class="line"><span style="color:#A6ACCD;">        draw </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ImageDraw</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Draw</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">match_img</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># 字体颜色</span></span>
<span class="line"><span style="color:#A6ACCD;">        font_color </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">232</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">98</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">85</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># 绘制文本</span></span>
<span class="line"><span style="color:#A6ACCD;">        draw</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">text</span><span style="color:#89DDFF;">((</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;</span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">round</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;">p</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">%&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">fill</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">font_color</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        match_images</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">append</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">match_img</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">plot_images</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">match_images</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">figsize</span><span style="color:#89DDFF;">=(</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">----------------------------------------------</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span></code></pre></div><p><img src="`+y+'" alt=""><img src="'+A+'" alt=""><img src="'+C+`" alt=""></p><h1 id="换用resnet网络训练对比" tabindex="-1">换用ResNet网络训练对比 <a class="header-anchor" href="#换用resnet网络训练对比" aria-label="Permalink to &quot;换用ResNet网络训练对比&quot;">​</a></h1><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">%%</span><span style="color:#A6ACCD;">time</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 训练模型</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 加载ResNet101模型</span></span>
<span class="line"><span style="color:#A6ACCD;">net </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> torchvision</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">models</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resnet101</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">pretrained</span><span style="color:#89DDFF;">=True)</span></span>
<span class="line"><span style="color:#A6ACCD;">num_features </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> net</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">fc</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">in_features</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 增加 dropout</span></span>
<span class="line"><span style="color:#A6ACCD;">net</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">fc</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Sequential</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">    torch</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Dropout</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0.5</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;">   </span><span style="color:#676E95;font-style:italic;"># 增加 dropout避免太快过拟合</span></span>
<span class="line"><span style="color:#82AAFF;">    torch</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Linear</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">num_features</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> total_classes_num</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 单层卷积, 替代了vgg的4096个全连接层,深,但是速度还更快</span></span>
<span class="line"><span style="color:#A6ACCD;">net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">model</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">eval</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 验证模块</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">criterion </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> nn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">CrossEntropyLoss</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">optimizer </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> optim</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Adam</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">parameters</span><span style="color:#89DDFF;">(),</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">lr</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.0001</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">weight_decay</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0.01</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 加入了l2正则化</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">check_iter </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># train check batch size </span></span>
<span class="line"><span style="color:#A6ACCD;">train_epoch </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">25</span></span>
<span class="line"><span style="color:#A6ACCD;">prefix </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;20240201_full_32x32_clear_</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">total_classes_num</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">class_l2_2-&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">batch_size</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> batch_size</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> epoch </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_epoch</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">train</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 每个epoch 后切换训练模式, 那么会不会保d留之前的训练权重呢?</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    progress_bar </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tqdm</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">enumerate</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataloader</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">total</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataloader</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> data </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> progress_bar</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        inputs</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> labels </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> data  </span><span style="color:#676E95;font-style:italic;"># 必须要float 归一化? 浮点类型.</span></span>
<span class="line"><span style="color:#A6ACCD;">        inputs</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> labels </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> inputs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">float</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> labels</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        optimizer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">zero_grad</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        outputs </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">net</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">inputs</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 这一步, 运行有问题, 这是为什么呢, 检查一下图片格式</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        loss </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">criterion</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">outputs</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> labels</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        loss</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">backward</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        optimizer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">step</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        progress_bar</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">set_description</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&#39;epoch:</span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">epoch</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">, loss: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">loss </span><span style="color:#89DDFF;">/</span><span style="color:#82AAFF;"> batch_size</span><span style="color:#C792EA;">:.3f</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> epoch </span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 每两个epoch进行一次验证</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">开始验证....</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">eval</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        correct </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 记录正确预测的数量</span></span>
<span class="line"><span style="color:#A6ACCD;">        total </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 总的样本数</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">with</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">no_grad</span><span style="color:#89DDFF;">():</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span></span>
<span class="line"><span style="color:#A6ACCD;">            progress_bar2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tqdm</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">enumerate</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataloader</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">total</span><span style="color:#89DDFF;">=</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataloader</span><span style="color:#89DDFF;">)</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0.4</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> data </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> progress_bar2</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">train_dataloader</span><span style="color:#89DDFF;">)</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0.4</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;font-style:italic;">break</span></span>
<span class="line"><span style="color:#A6ACCD;">                inputs</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> labels </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> data</span></span>
<span class="line"><span style="color:#A6ACCD;">                inputs</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> labels </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> inputs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">float</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> labels</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">to</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">device</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                outputs </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">net</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">inputs</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                _</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> predicted </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">max</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">outputs</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">data</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                total </span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> labels</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">size</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 实际的样本数</span></span>
<span class="line"><span style="color:#A6ACCD;">                correct </span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">predicted </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> labels</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">sum</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">item</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 正确预测的样本数</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">        accuracy </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">round</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">correct </span><span style="color:#89DDFF;">/</span><span style="color:#82AAFF;"> total </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 计算准确率</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&#39;epoch: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">epoch</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">, Accuracy: </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">accuracy</span><span style="color:#C792EA;">:.3f</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> accuracy </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">60</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 太小的根本没比较保存</span></span>
<span class="line"><span style="color:#A6ACCD;">            save_model_path </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">prefix</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">_resnet101_</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">epoch</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">_</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">accuracy</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">.pth&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">            torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">save</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">state_dict</span><span style="color:#89DDFF;">(),</span><span style="color:#82AAFF;"> save_model_path</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;model save: &quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> save_model_path</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">    torch</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">cuda</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">empty_cache</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Finished Training</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">save_model_path </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">prefix</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">_resnet101_</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">epoch</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">_</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">accuracy</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">.pth&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">torch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">save</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">net</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">state_dict</span><span style="color:#89DDFF;">(),</span><span style="color:#82AAFF;"> save_model_path</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;model save: &quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> save_model_path</span><span style="color:#89DDFF;">)</span></span></code></pre></div><h2 id="resnet模型验证" tabindex="-1">ResNet模型验证 <a class="header-anchor" href="#resnet模型验证" aria-label="Permalink to &quot;ResNet模型验证&quot;">​</a></h2><p>得益于<code>ResNet</code>采用了跳跃链接, 损失值能够更好的在更深的网络中进行传递, 表现的效果就是训练更容易收敛了.</p><p>训练的输出如下, 可以看到resnet的收敛速度极快, 10个epoch以内就可以达到90%的准确率,, 而vggNet则要接近10个epoch是远远没法达到90%准确率的.<br> ResNet准确性更高, 所以如果是实际应用产品的话, 可以直接不用管古老的历史包袱了, vgg当然也有它的标志性意义. 但是真实省事, 确实直接选模型挑选新一点的, 会少一些坑. 🤔</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">epoch:4,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">loss:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0.005</span><span style="color:#C3E88D;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">100</span><span style="color:#C3E88D;">%</span><span style="color:#89DDFF;">|</span><span style="color:#FFCB6B;">███████████████████████████████████████████████████████████████████████████████████████████████████████</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">85/85</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">02</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">45</span><span style="color:#89DDFF;">&lt;</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">,  1.95s/it</span><span style="color:#89DDFF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">开始验证.</span><span style="color:#82AAFF;">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">%</span><span style="color:#89DDFF;">|</span><span style="color:#FFCB6B;">█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">34/34</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">17</span><span style="color:#89DDFF;">&lt;</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">,  1.90it/s</span><span style="color:#89DDFF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">epoch:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#C3E88D;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Accuracy:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">96.507</span></span>
<span class="line"><span style="color:#FFCB6B;">model</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">save:</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">20240201_full_32x32_clear_906class_l2_2-_resnet101_4_96.507.pth</span></span></code></pre></div><p>载入训练后模型, 使用上面vgg16验证的代码, 进行验证, 对比后发现, 整体的泛化能力, ResNet要更好, 很多VggNet没能稳定识别的验证图片, ResNet都能比较稳定的以比较高的识别率进行识别.</p><h1 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h1><p>一时兴起的小需求, 也很多小细节需要处理. 大批量数据运行前, 需要先抽少一些类进行小批量的快速验证, 对模型和训练数据进行验证. 这次我就是先用20类进行验证, 之后才进行900多类的训练.</p><p>一开始用vgg, 用的是224x224的图片输入, 后面为了提速.因为是像素画,只要不要平滑, 32x32也足够清晰, 所以就调整vgg结构, 方便进行增加更多的batch_size进行更快的训练.及时调整了输入图片的尺寸以后, 我的电脑训练起来也快了很多, 40多分钟就可以完成25轮 128batch_size的模型训练, 体验还不错!</p><p>然后就是, 可以的话, 主动挑选更新的代码, 老的模型, 经典, 但是效果远不如新一些的模型.ResNet更快收敛, 更快训练(笑...)</p><p><a href="https://github.com/realzhengyiming/isaac_tools/blob/main/simple_issac_item_recognition-%E5%85%A8%E9%87%8F%E8%AE%AD%E7%BB%83%E7%9A%84%E7%89%88%E6%9C%AC.ipynb" target="_blank" rel="noreferrer">模型训练完整代码</a><br><a href="https://github.com/realzhengyiming/isaac_tools/blob/main/isaac_data_spider.py" target="_blank" rel="noreferrer">数据获取和处理的完整代码</a> 代码都在github上了.<br> 我要去玩游戏了, 以撒真好玩 : )</p><h2 id="后续优化" tabindex="-1">后续优化 <a class="header-anchor" href="#后续优化" aria-label="Permalink to &quot;后续优化&quot;">​</a></h2><ul><li>增加一下真实的截图作为训练数据, 以进一步提高各个类别的准确度</li><li>进一步增加一些其他的数据增强, 以更好的模拟真实的使用情况</li></ul><ul><li>[x] 考虑换用其他模型(resnet替换验证, 改进的模型明显更好, 历史包袱应该早日丢弃.)</li></ul><ul><li>部署模型到移动端, 封装成应用进行使用, 改训练目标检测模型.</li></ul>`,44);function u(h,g,E,b,q,v){const n=c("BabyPulm");return t(),p("div",null,[f,_,d,o(n),m])}const k=l(i,[["render",u]]);export{B as __pageData,k as default};
